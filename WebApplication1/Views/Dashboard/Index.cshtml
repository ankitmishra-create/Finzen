@using FinanceManagement.Application.Utility
@using FinanceManagement.Core.Entities
@using FinanceManagement.Core.Enums
@using FinanceManagement.Application.DTO

@* --- The Model is correct --- *@
@model DashboardDto

@{
    ViewData["Title"] = "Dashboard";
}

@* We don't need the old <style> block anymore.
    All styling is now handled by Tailwind utility classes.
*@

<div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">
            Welcome back, @User.Identity.Name!
        </h1>
        <p class="text-lg text-gray-500">
            Here's an overview of your financial activity.
        </p>
    </div>

    <div class="flex-shrink-0">
        <form asp-controller="Dashboard" asp-action="Index" method="post" class="flex items-center gap-2">
            @Html.AntiForgeryToken()
            <label for="currencySelector" class="text-sm font-medium text-gray-700">Currency:</label>
            <select name="selectedCurrencyCode" id="currencySelector"
                    class="block w-40 rounded-lg border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-sm font-medium"
                    onchange="this.form.submit()"
                    asp-items="@(ViewBag.CurrencyList as List<SelectListItem>)">
            </select>
        </form>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">

    <div class="bg-white rounded-xl shadow-md p-6 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-full inline-flex items-center justify-center bg-green-100">
                <i class="bi bi-arrow-up text-green-600 text-3xl"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Income</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">
                    @ViewBag.CurrencySymbol @Model.TotalIncome.ToString("N2")
                </p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-full inline-flex items-center justify-center bg-red-100">
                <i class="bi bi-arrow-down text-red-600 text-3xl"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Expense</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">
                    @ViewBag.CurrencySymbol @Model.TotalExpense.ToString("N2")
                </p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-full inline-flex items-center justify-center bg-violet-100">
                <i class="bi bi-wallet2 text-violet-600 text-3xl"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Balance Available</p>
                <p class="text-3xl font-bold text-gray-900 mt-1">
                    @ViewBag.CurrencySymbol @Model.TotalBalance.ToString("N2")
                </p>
            </div>
        </div>
    </div>
</div>


<div class="mt-8 bg-white rounded-xl shadow-md overflow-hidden">

    <div class="flex flex-col sm:flex-row justify-between sm:items-center p-5 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900 mb-3 sm:mb-0">
            Recent Transactions
        </h2>
        <div class="flex gap-3">
            <a asp-controller="Transaction" asp-action="Index" class="px-4 py-2 text-sm font-medium text-violet-600 border border-violet-600 rounded-lg hover:bg-violet-50 transition-all">
                Manage Transactions
            </a>
            <a asp-controller="Category" asp-action="Index" class="px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
                Manage Categories
            </a>
        </div>
    </div>

    <div class="w-full overflow-x-auto">
        <table class="table-auto w-full text-left">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Amount</th>
                </tr>
            </thead>

            <tbody class="divide-y divide-gray-200">
                @if (Model.RecentTransaction != null && Model.RecentTransaction.Any())
                {
                    @foreach (var item in Model.RecentTransaction)
                    {
                        // --- Safe variables (same logic as before) ---
                        var categoryType = item.Category?.CategoryType ?? CategoryType.Expense;
                        var categoryName = item.Category?.CategoryName ?? "Unknown Category";
                        var amountPrefix = categoryType == CategoryType.Income ? "+" : "-";

                        // --- NEW Tailwind Badge Classes ---
                        var badgeClass = categoryType == CategoryType.Income ?
                        "bg-green-100 text-green-800" :
                        "bg-red-100 text-red-800";

                        // --- NEW Tailwind Amount Classes ---
                        var amountClass = categoryType == CategoryType.Income ?
                        "text-green-600" :
                        "text-red-600";

                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @badgeClass">
                                    @categoryType
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">
                                @categoryName
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @item.Description
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                @item.TransactionDate?.ToShortDateString()
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right @amountClass">
                                @amountPrefix @ViewBag.CurrencySymbol @item.Amount?.ToString("N2")
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center py-10 text-gray-500">
                            No recent transactions found.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>