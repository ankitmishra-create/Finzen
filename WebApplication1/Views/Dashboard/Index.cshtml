@using FinanceManagement.Application.Utility
@using FinanceManagement.Core.Entities
@using FinanceManagement.Core.Enums
@using FinanceManagement.Application.DTO 

@* --- HIGHLIGHTED: THE MODEL IS NOW DashboardDto --- *@
@model DashboardDto

@{
    ViewData["Title"] = "Dashboard";
}

@* (Your <style> section is perfect, no changes needed) *@
<style>
    .summary-card {
        container-type: inline-size;
    }

    .summary-card-icon { /* ... */
    }

    .summary-card:hover .summary-card-icon { /* ... */
    }

    .amount-display { /* ... */
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">Dashboard</h1>
        <p class="text-muted mb-0">An overview of your financial activity.</p>
    </div>

    

    <div class="d-flex align-items-center gap-2">
        <label for="currencySelector" class="form-label mb-0 small text-muted">Currency:</label>

        @* --- HIGHLIGHTED: Added AntiForgeryToken --- *@
        <form asp-controller="Dashboard" asp-action="Index" method="post" class="d-flex align-items-center gap-2">
            @Html.AntiForgeryToken()

            @* --- HIGHLIGHTED: Using asp-items for a clean dropdown --- *@
            <select name="selectedCurrencyCode" id="currencySelector"
                    class="form-select form-select-sm" style="width: 160px;"
                    onchange="this.form.submit()"
                    asp-items="@(ViewBag.CurrencyList as List<SelectListItem>)">
            </select>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-3">
        <div class="card h-100 summary-card bg-success-subtle border-success shadow-sm position-relative">
            <div class="card-body p-4">
                <div class="summary-card-icon text-success">
                    <i class="bi bi-arrow-up-circle"></i>
                </div>
                <h6 class="card-title text-success-emphasis mb-1">TOTAL INCOME</h6>
                <h3 class="fw-bold text-success-emphasis mb-0 amount-display">
                    @* --- HIGHLIGHTED: Using @Model property --- *@
                    @ViewBag.CurrencySymbol @Model.TotalIncome.ToString("N2")
                </h3>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card h-100 summary-card bg-danger-subtle border-danger shadow-sm position-relative">
            <div class="card-body p-4">
                <div class="summary-card-icon text-danger">
                    <i class="bi bi-arrow-down-circle"></i>
                </div>
                <h6 class="card-title text-danger-emphasis mb-1">TOTAL EXPENSE</h6>
                <h3 class="fw-bold text-danger-emphasis mb-0 amount-display">
                    @* --- HIGHLIGHTED: Using @Model property --- *@
                    @ViewBag.CurrencySymbol @Model.TotalExpense.ToString("N2")
                </h3>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card h-100 summary-card bg-primary-subtle border-primary shadow-sm position-relative">
            <div class="card-body p-4">
                <div class="summary-card-icon text-primary">
                    <i class="bi bi-wallet2"></i>
                </div>
                <h6 class="card-title text-primary-emphasis mb-1">BALANCE AVAILABLE</h6>
                <h3 class="fw-bold text-primary-emphasis mb-0 amount-display">
                    @* --- HIGHLIGHTED: Using @Model property --- *@
                    @ViewBag.CurrencySymbol @Model.TotalBalance.ToString("N2")
                </h3>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Transactions</h5>
            <div class="d-flex gap-2">
                <a asp-controller="Transaction" asp-action="Index" class="btn btn-sm btn-outline-primary">Manage Transactions</a>
                <a asp-controller="Category" asp-action="Index" class="btn btn-sm btn-outline-secondary">Manage Categories</a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">Category Type</th>
                            <th>Category Name</th>
                            <th>Description</th>
                            <th>Transaction Date</th>
                            <th class="text-end pe-3">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* --- HIGHLIGHTED: Looping over @Model.RecentTransaction --- *@
                        @if (Model.RecentTransaction != null && Model.RecentTransaction.Any())
                        {
                            @foreach (var item in Model.RecentTransaction)
                            {
                                // --- HIGHLIGHTED: Default values if Category is null ---
                                var categoryType = item.Category?.CategoryType ?? CategoryType.Expense; // Default to Expense if null
                                var categoryName = item.Category?.CategoryName ?? "Unknown Category"; // Default text
                                var amountPrefix = categoryType == CategoryType.Income ? "+" : "-";
                                var badgeClass = categoryType == CategoryType.Income ? "bg-success-subtle text-success-emphasis" : "bg-danger-subtle text-danger-emphasis";
                                var amountClass = categoryType == CategoryType.Income ? "text-success" : "text-danger";
                                // --- END HIGHLIGHTED ---

                                <tr>
                                    <td class="ps-3">
                                        @* --- HIGHLIGHTED: Using the safe variables --- *@
                                        <span class="badge @badgeClass">
                                            @categoryType
                                        </span>
                                    </td>
                                    @* --- HIGHLIGHTED: Using the safe variable --- *@
                                    <td>@categoryName</td>
                                    <td>@item.Description</td>
                                    <td>@item.TransactionDate?.ToShortDateString()</td>
                                    @* --- HIGHLIGHTED: Using the safe variables --- *@
                                    <td class="text-end pe-3 fw-bold @amountClass">
                                        @amountPrefix @ViewBag.CurrencySymbol @item.Amount?.ToString("N2")
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted p-4">No recent transactions found.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>