@model FinanceManagement.Application.ViewModels.ReportVM
@using Newtonsoft.Json
@using FinanceManagement.Core.Entities
@using FinanceManagement.Core.Enums

@{
    ViewData["Title"] = "Report Generation";
    var today = DateTime.Today.ToString("yyyy-MM-dd");

    // Safely serialize categories (project if needed to avoid EF navigation loops)
    var categoriesJson = Html.Raw(JsonConvert.SerializeObject(
        (Model?.Categories ?? new List<Category>())
            .Select(c => new { c.CategoryId, c.CategoryName, c.CategoryType })
    ));

    // Preserve selections
    var selType = Model?.CategoryType.HasValue == true ? ((int)Model.CategoryType.Value).ToString() : "";
    var selCatId = (Model?.SubCategory is Guid g) ? g.ToString() : "";

    var selTypeJson = Html.Raw(JsonConvert.SerializeObject(selType));
    var selCatIdJson = Html.Raw(JsonConvert.SerializeObject(selCatId));
}

<div class="bg-white rounded-xl shadow-md p-6">
    <form asp-controller="Report" asp-action="Index" method="post" novalidate>
        @Html.AntiForgeryToken()

        <h2 class="text-xl font-semibold text-gray-900 border-b border-gray-200 pb-4 mb-6">
            <i class="bi bi-file-earmark-text text-violet-600"></i>
            Select Report Criteria
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div>
                <label asp-for="StartDate" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <input asp-for="StartDate"
                       type="date"
                       max="@today"
                       class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500" />
                <span asp-validation-for="StartDate" class="text-xs text-red-600"></span>
            </div>

            <div>
                <label asp-for="EndDate" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <input asp-for="EndDate"
                       type="date"
                       max="@today"
                       class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500" />
                <span asp-validation-for="EndDate" class="text-xs text-red-600"></span>
            </div>

            <div>
                <label asp-for="CategoryType" class="block text-sm font-medium text-gray-700 mb-1">Category Type</label>
                <select asp-for="CategoryType" id="categoryType"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500">
                    <option value="">All Types</option>
                    <option value="1">Income</option>
                    <option value="2">Expense</option>
                </select>
                <span asp-validation-for="CategoryType" class="text-xs text-red-600"></span>
            </div>

            <div>
                <label asp-for="SubCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select asp-for="SubCategory" id="categoryId"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500">
                    <option value="">All Categories</option>
                </select>
                <span asp-validation-for="SubCategory" class="text-xs text-red-600"></span>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-sm text-gray-500" id="report-message">
                @if (Model?.Transactions != null && Model.Transactions.Any())
                {
                    <span>Found @Model.Transactions.Count() transaction(s).</span>
                }
            </div>
            <div class="flex gap-3">
                
                <button type="submit"
                        class="flex items-center gap-2 bg-violet-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md hover:bg-violet-700">
                    <i class="bi bi-file-earmark-arrow-down-fill"></i> Generate
                </button>
            </div>
        </div>
    </form>
</div>

<div class="mt-10 bg-white rounded-xl shadow-md overflow-hidden">
    <div class="p-6">
        <h2 class="text-xl font-semibold text-gray-900"><i class="bi bi-table text-violet-600"></i> Report Results</h2>
    </div>

    <div id="report-results-container">
        @if (Model?.Transactions != null)
        {
            if (Model.Transactions.Any())
            {
                var sorted = Model.Transactions.OrderBy(t => t.TransactionDate).ToList();
                <div class="w-full overflow-x-auto">
                    <table class="table-auto w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-xs text-gray-500 uppercase">Date</th>
                                <th class="px-6 py-3 text-xs text-gray-500 uppercase">Category</th>
                                <th class="px-6 py-3 text-xs text-gray-500 uppercase">Type</th>
                                <th class="px-6 py-3 text-xs text-gray-500 uppercase">Description</th>
                                <th class="px-6 py-3 text-xs text-gray-500 uppercase text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                        @foreach (var t in sorted)
                        {
                            var categoryType = t.Category?.CategoryType.ToString() ?? "N/A";
                            var isIncome = t.Category?.CategoryType == CategoryType.Income;
                            var badgeClass = isIncome ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
                            var amountClass = isIncome ? "text-green-600" : "text-red-600";

                            <tr>
                                <td class="px-6 py-3 text-sm text-gray-900">@t.TransactionDate?.ToString("yyyy-MM-dd")</td>
                                <td class="px-6 py-3 text-sm text-gray-900">@t.Category?.CategoryName</td>
                                <td class="px-6 py-3 text-sm">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @badgeClass">
                                        @categoryType
                                    </span>
                                </td>
                                <td class="px-6 py-3 text-sm text-gray-900">@t.Description</td>
                                <td class="px-6 py-3 text-sm font-semibold text-right @amountClass">
                                    @t.Amount?.ToString("N2")
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-20 text-gray-500">
                    <i class="bi bi-calendar-x text-5xl mb-3"></i>
                    <p class="text-lg font-medium">No transactions found for the selected criteria.</p>
                </div>
            }
        }
        else
        {
            <div class="text-center py-20 text-gray-500">
                <i class="bi bi-search text-5xl mb-3"></i>
                <p class="text-lg font-medium">Your generated report will appear here.</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Data from server
        const allCategories = @categoriesJson;
        const selectedType = @selTypeJson;       // "", "1", "2"
        const selectedCategoryId = @selCatIdJson; // "" or GUID string

        // Grabs
        const categoryTypeSelect = document.getElementById('categoryType');
        const categorySelect = document.getElementById('categoryId');
        const btnPrint = document.getElementById('btnPrint');
        const s = document.getElementById('StartDate');
        const e = document.getElementById('EndDate');
        const today = '@today';

        // Keep your original UX: if empty/min, set to today; otherwise leave userâ€™s choice
        (function initDates() {
            if (s && (!s.value || s.value === '0001-01-01')) s.value = today;
            if (e && (!e.value || e.value === '0001-01-01')) e.value = today;
        })();

        function populateCategories(typeVal, currentId) {
            categorySelect.innerHTML = '<option value="">All Categories</option>';

            let filtered = Array.isArray(allCategories) ? allCategories.slice() : [];

            const t = parseInt(typeVal);
            if (!Number.isNaN(t)) {
                filtered = filtered.filter(c => c.CategoryType === t);
            }

            for (const c of filtered) {
                // Value is GUID string for binding to Guid? SubCategory
                const opt = new Option(c.CategoryName, c.CategoryId);
                categorySelect.add(opt);
            }

            if (currentId) {
                categorySelect.value = currentId;
                if (categorySelect.value !== currentId) {
                    categorySelect.value = '';
                }
            }
        }

        // Initialize with preserved selections
        (function initFilters() {
            if (selectedType !== '') categoryTypeSelect.value = selectedType;
            populateCategories(categoryTypeSelect.value, selectedCategoryId);
        })();

        categoryTypeSelect.addEventListener('change', function () {
            populateCategories(this.value, '');
        });

        btnPrint.addEventListener('click', function () {
            window.print();
        });

        // Friendly date guard (message only)
        const msg = document.getElementById('report-message');
        function validateDates() {
            if (s && e && s.value && e.value && s.value > e.value) {
                msg.textContent = 'End Date should be on or after Start Date.';
            } else {
                msg.textContent = '';
            }
        }
        s?.addEventListener('change', validateDates);
        e?.addEventListener('change', validateDates);
    </script>
}
