@using FinanceManagement.Core.Enums
@model List<FinanceManagement.Application.DTO.SavingDto>

@{
    ViewData["Title"] = "Saving Overview";
    var jsonSavings = System.Text.Json.JsonSerializer.Serialize(Model);
}

<div class="p-6 sm:p-10 bg-gray-50 min-h-screen">

    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">💰 Saving Overview</h1>

        <div class="flex flex-col sm:flex-row gap-3">
            <div id="savingTypeGroup" class="flex gap-3">
                <button id="generalBtn"
                        class="px-5 py-2 rounded-lg bg-violet-600 text-white font-medium hover:bg-violet-700 transition active">
                    General
                </button>
                <button id="incomeBtn"
                        class="px-5 py-2 rounded-lg bg-emerald-600 text-white font-medium hover:bg-emerald-700 transition">
                    Income
                </button>
            </div>

            <a asp-controller="Saving" asp-action="Create"
               class="px-5 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition text-center">
                + Add Saving
            </a>
        </div>
    </div>

    <div id="savingChart" class="space-y-6"></div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const savings = @Html.Raw(jsonSavings);
            const chartContainer = document.querySelector("#savingChart");
            let activeCharts = [];

            // Map type to label for clarity
            function getTypeLabel(type) {
                if (type === 1) return "Income";
                return "General";
            }

            function setActiveButton(selectedBtn) {
                document.querySelectorAll('#savingTypeGroup button').forEach(btn =>
                    btn.classList.remove('active', 'ring-2', 'ring-offset-2', 'ring-violet-300')
                );
                if (selectedBtn)
                    selectedBtn.classList.add('active', 'ring-2', 'ring-offset-2', 'ring-violet-300');
            }

            function filterByType(type, btnElement) {
                setActiveButton(btnElement);
                const filtered = savings.filter(s => {
                    if (type === null) return s.CategoryType === null;
                    return s.CategoryType === type;
                });
                showSavingsIndividually(type, filtered);
            }

            function showSavingsIndividually(type, filteredSavings) {
                activeCharts.forEach(c => c.destroy());
                activeCharts = [];
                chartContainer.innerHTML = "";

                if (filteredSavings.length === 0) {
                    chartContainer.innerHTML =
                        `<div class='text-gray-500 text-center py-10 text-lg font-medium'>
                            No ${getTypeLabel(type)} savings found.
                        </div>`;
                    return;
                }

                filteredSavings.forEach((s, i) => {
                    const total = s.SavingAmount || 0;
                    const saved = s.AlreadySavedAmount || 0;
                    const remaining = total - saved;
                    const endDate = new Date(s.SavingEndDate);
                    const today = new Date();
                    const daysLeft = isNaN(endDate) ? "-" : Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));

                    const cardId = `chart-${i}`;
                    const contentId = `content-${i}`;
                    const card = document.createElement("div");
                    card.className = "bg-white shadow-md rounded-xl border border-gray-200 overflow-hidden transition hover:shadow-lg";

                    card.innerHTML = `
                        <div class="flex justify-between items-center px-6 py-4 cursor-pointer bg-gray-100 hover:bg-gray-200 transition"
                             onclick="toggleCard('${contentId}', this)">
                             <div>
                                <h3 class="text-lg font-semibold text-violet-700">${s.SavingName || "Unnamed Saving"}</h3>
                                <p class="text-sm text-gray-500">${s.CategoryName || getTypeLabel(type)}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-sm text-gray-600 hidden md:block"><span class="font-medium">Total:</span> ₹${total.toFixed(2)}</div>
                                <div class="text-sm text-emerald-500 hidden lg:block"><span class="font-medium">Saved:</span> ₹${saved.toFixed(2)}</div>
                                <div class="text-sm text-gray-600 hidden lg:block"><span class="font-medium">Remaining:</span> ₹${remaining.toFixed(2)}</div>
                                <div class="text-sm text-gray-500 hidden md:block"><span class="font-medium">Days Left:</span> ${daysLeft}</div>

                                <div class="flex gap-2">
                                    <a href="/Saving/Edit/${s.SavingId}"
                                       class="flex items-center gap-1 px-3 py-1 rounded-md text-xs font-medium bg-blue-500 text-white hover:bg-blue-600 transition"
                                       onclick="event.stopPropagation()">
                                       <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    <a href="/Saving/Delete/${s.SavingId}"
                                       class="flex items-center gap-1 px-3 py-1 rounded-md text-xs font-medium bg-red-500 text-white hover:bg-red-600 transition"
                                       onclick="event.stopPropagation(); return confirm('Are you sure you want to delete this saving: \'${s.SavingName.replace(/'/g, "\\'")}\' ?')">
                                       <i class="bi bi-trash-fill"></i>
                                    </a>
                                </div>
                                <i class="bi bi-chevron-down text-gray-600 transition-transform"></i>
                            </div>
                        </div>

                        <div id="${contentId}" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out">
                            <div class="p-6 space-y-4">
                                <p class="text-sm text-gray-600 border-l-4 border-violet-500 pl-3 italic">${s.Description || "No description provided."}</p>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-xs text-gray-500 uppercase">Total</p>
                                        <p class="text-lg font-semibold text-gray-800">₹${total.toFixed(2)}</p>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-xs text-gray-500 uppercase">Saved</p>
                                        <p class="text-lg font-semibold text-emerald-500">₹${saved.toFixed(2)}</p>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-xs text-gray-500 uppercase">Remaining</p>
                                        <p class="text-lg font-semibold text-gray-800">₹${remaining.toFixed(2)}</p>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-xs text-gray-500 uppercase">Days Left</p>
                                        <p class="text-lg font-semibold text-violet-600">${daysLeft}</p>
                                    </div>
                                </div>

                                <div class="w-full h-64" id="${cardId}"></div>
                            </div>
                        </div>
                    `;

                    chartContainer.appendChild(card);

                    const chart = new ApexCharts(document.querySelector(`#${cardId}`), {
                        series: [saved, remaining],
                        chart: { type: 'donut', height: 250 },
                        labels: ['Saved', 'Remaining'],
                        colors: ['#10b981', '#a78bfa'],
                        legend: { position: 'bottom', fontSize: '13px' },
                        dataLabels: { formatter: val => `${val.toFixed(1)}%` },
                        tooltip: { y: { formatter: val => `₹${val.toFixed(2)}` } },
                        responsive: [{ breakpoint: 640, options: { chart: { height: 220 } } }]
                    });

                    chart.render();
                    activeCharts.push(chart);
                });
            }

            // Collapse / Expand Function
            window.toggleCard = function (id, header) {
                const content = document.getElementById(id);
                const icon = header.querySelector("i.bi-chevron-down");

                if (content.classList.contains("max-h-0")) {
                    content.classList.remove("max-h-0");
                    content.classList.add("max-h-[1000px]");
                    icon.classList.add("rotate-180");
                } else {
                    content.classList.remove("max-h-[1000px]");
                    content.classList.add("max-h-0");
                    icon.classList.remove("rotate-180");
                }
            };

            // Button wiring
            const generalBtn = document.getElementById("generalBtn");
            const incomeBtn = document.getElementById("incomeBtn");

            generalBtn.onclick = () => filterByType(null, generalBtn);
            incomeBtn.onclick = () => filterByType(1, incomeBtn); // Income → type = 1

            // Default view
            generalBtn.click();
        });
    </script>
}
