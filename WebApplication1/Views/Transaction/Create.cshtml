@using FinanceManagement.Application.ViewModels
@using FinanceManagement.Core.Enums
@model AddTransactionVM

@{
    ViewData["Title"] = "Create Transaction";
    Model.TransactionTimeLine = TransactionTimeLine.OneTime;
}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">@ViewData["Title"]</h1>
    <a asp-action="Index" class="text-base font-medium text-violet-600 hover:text-violet-500">
        <i class="bi bi-arrow-left"></i>
        Back to List
    </a>
</div>

<div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6 sm:p-8 transition-all duration-300 hover:shadow-lg">

    <form method="post" asp-action="Create">
        <div asp-validation-summary="ModelOnly" class="text-red-600 text-base list-disc list-inside mb-4" role="alert"></div>
        <input type="hidden" asp-for="UserId" />

        <div class="space-y-6">

            <!-- Transaction TimeLine (Existing) -->
            <div>
                <label asp-for="TransactionTimeLine" class="block text-base font-medium text-gray-700 mb-2"></label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <input class="sr-only peer"
                               type="radio"
                               asp-for="TransactionTimeLine"
                               value="OneTime"
                               id="timeline_OneTime" />
                        <label class="block w-full p-4 text-center rounded-lg border-2 border-gray-400 cursor-pointer text-gray-700 font-medium peer-checked:border-violet-600 peer-checked:bg-violet-600 peer-checked:text-white transition-all"
                               for="timeline_OneTime">
                            One-Time Payment
                        </label>
                    </div>
                    <div>
                        <input class="sr-only peer"
                               type="radio"
                               asp-for="TransactionTimeLine"
                               value="Recurring"
                               id="timeline_Recurring" />
                        <label class="block w-full p-4 text-center rounded-lg border-2 border-gray-400 cursor-pointer text-gray-700 font-medium peer-checked:border-green-600 peer-checked:bg-green-600 peer-checked:text-white transition-all"
                               for="timeline_Recurring">
                            Recurring Payment
                        </label>
                    </div>
                </div>
                <span asp-validation-for="TransactionTimeLine" class="text-red-600 text-base mt-1"></span>
            </div>

            <!-- Frequency (Existing) -->
            <div id="frequencyContainer" style="display:none;">
                <label asp-for="RecurrenceFrequency" class="block text-base font-medium text-gray-700 mb-1"></label>
                <select asp-for="RecurrenceFrequency"
                        asp-items="ViewBag.RecurrenceFrequency"
                        class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base appearance-none bg-no-repeat bg-right pr-8"
                        id="frequencySelect">
                    <option value="">-- Select Frequency --</option>
                </select>
                <span asp-validation-for="RecurrenceFrequency" class="text-red-600 text-base mt-1"></span>
            </div>

            <!-- Territory / Currency (Existing) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label asp-for="TransactionTerrority" class="block text-base font-medium text-gray-700 mb-1"></label>
                    <select asp-for="TransactionTerrority"
                            asp-items="Html.GetEnumSelectList<TransactionTerrority>()"
                            class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base appearance-none bg-no-repeat bg-right pr-8"
                            id="territorySelect">
                    </select>
                    <span asp-validation-for="TransactionTerrority" class="text-red-600 text-base mt-1"></span>
                </div>
                <div id="currencyContainer" style="display:none;">
                    <label asp-for="SelectedCurrency" class="block text-base font-medium text-gray-700 mb-1"></label>
                    <select asp-for="SelectedCurrency"
                            asp-items="ViewBag.Available"
                            class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base appearance-none bg-no-repeat bg-right pr-8"
                            id="currencySelect">
                        <!-- <-- Added ID -->
                        <option value="">-- Select Currency --</option>
                    </select>
                    <span asp-validation-for="SelectedCurrency" class="text-red-600 text-base mt-1"></span>
                </div>
            </div>

            <!-- Amount + Date (Existing) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label asp-for="Amount" class="block text-base font-medium text-gray-700 mb-1"></label>
                    <input asp-for="Amount" id="Amount" class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base" placeholder="0.00" />
                    <span asp-validation-for="Amount" class="text-red-600 text-base mt-1"></span>
                </div>
                <div>
                    <label asp-for="TransactionDate" class="block text-base font-medium text-gray-700 mb-1"></label>
                    <input asp-for="TransactionDate" type="date"
                           class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base"
                           value="@DateTime.Today.ToString("yyyy-MM-dd")"
                           max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    <span asp-validation-for="TransactionDate" class="text-red-600 text-base mt-1"></span>
                </div>
            </div>

            <!-- Category (Existing) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label asp-for="CategoryType" class="block text-base font-medium text-gray-700 mb-1"></label>
                    <select asp-for="CategoryType"
                            class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base appearance-none bg-no-repeat bg-right pr-8"
                            id="categoryTypeSelect">
                        <option value="">-- Select Type --</option>
                        <option value="Income">Income</option>
                        <option value="Expense">Expense</option>
                    </select>
                    <span asp-validation-for="CategoryType" class="text-red-600 text-base mt-1"></span>
                </div>
                <div>
                    <label asp-for="CategoryId" class="block text-base font-medium text-gray-700 mb-1"></label>
                    <select asp-for="CategoryId"
                            class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base appearance-none bg-no-repeat bg-right pr-8"
                            id="categorySelect">
                        <option value="">-- Select Category --</option>
                        @if (Model.Categories != null)
                        {
                            foreach (var category in Model.Categories)
                            {
                                <option value="@category.CategoryId" data-type="@category.CategoryType.ToString()">@category.CategoryName</option>
                            }
                        }
                    </select>
                    <span asp-validation-for="CategoryId" class="text-red-600 text-base mt-1"></span>
                </div>
            </div>

            <!-- Savings Allocation (Existing) -->
            <div id="savingsAllocationContainer" style="display:none;" class="space-y-4">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input asp-for="IsForSaving" type="checkbox" id="isForSavingToggle" class="sr-only peer" />
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-violet-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
                    <span class="ml-3 text-base font-medium text-gray-700">Add Transaction to Savings</span>
                </label>

                <div id="savingsCard" class="collapse-card" aria-hidden="true" style="display:none;">
                    <div class="p-4 rounded-lg bg-gray-50 shadow-inner space-y-4">
                        <h5 class="text-lg font-semibold text-gray-900">Available Savings</h5>
                        <div id="savingsList" class="space-y-3">
                            @if (Model.AvailableSavings.Any())
                            {
                                for (int i = 0; i < Model.AvailableSavings.Count; i++)
                                {
                                    var saving = Model.AvailableSavings[i];
                                    var categoryId = saving.CategoryId?.ToString() ?? "general";

                                    var categoryName = saving.CategoryId == null
                                    ? "General"
                                    : Model.Categories.FirstOrDefault(c => c.CategoryId == saving.CategoryId)?.CategoryName ?? "General";

                                    <div class="saving-item" data-category-id="@categoryId" style="display:none;">
                                        <label class="block text-sm font-medium text-gray-700">
                                            @saving.SavingName (@categoryName)
                                        </label>
                                        <input type="hidden" name="SavingAllocationVms[@i].AllocatedSavigId" value="@saving.SavingId" />
                                        <input type="number" step="0.01" min="0" name="SavingAllocationVms[@i].Amount"
                                               class="allocation-amount block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base"
                                               placeholder="0.00" data-container="savings" />
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-gray-500">No savings goals found.</p>
                            }
                        </div>
                        <div class="pt-2 border-t border-gray-200">
                            <strong class="text-base">Total Allocated: <span id="savingsTotal">0.00</span></strong>
                            <span id="savingsError" class="text-red-600 text-sm block" style="display:none;">Total allocation cannot exceed transaction amount.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Allocation (Existing) -->
            <div id="budgetAllocationContainer" style="display:none;" class="space-y-4">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input asp-for="IsForBudget" type="checkbox" id="isForBudgetToggle" class="sr-only peer" />
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-violet-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
                    <span class="ml-3 text-base font-medium text-gray-700">Add Transaction to Budgets</span>
                </label>

                <div id="budgetCard" class="collapse-card" aria-hidden="true" style="display:none;">
                    <div class="p-4 rounded-lg bg-gray-50 shadow-inner space-y-4">
                        <h5 class="text-lg font-semibold text-gray-900">Available Budgets</h5>
                        <div id="budgetList" class="space-y-3">
                            @if (Model.AvailableBudgets.Any())
                            {
                                for (int i = 0; i < Model.AvailableBudgets.Count; i++)
                                {
                                    var budget = Model.AvailableBudgets[i];
                                    var categoryId = budget.CategoryId?.ToString() ?? "general";

                                    var categoryName = budget.CategoryId == null
                                    ? "General"
                                    : Model.Categories.FirstOrDefault(c => c.CategoryId == budget.CategoryId)?.CategoryName ?? "General";

                                    <div class="budget-item" data-category-id="@categoryId" style="display:none;">
                                        <label class="block text-sm font-medium text-gray-700">
                                            @budget.BudgetName (@categoryName)
                                        </label>
                                        <input type="hidden" name="BudgetAllocationVMs[@i].AllocatedBudgetId" value="@budget.BudgetId" />
                                        <input type="number" step="0.01" min="0" name="BudgetAllocationVMs[@i].Amount"
                                               class="allocation-amount block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base"
                                               placeholder="0.00" data-container="budget" />
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-gray-500">No budgets found.</p>
                            }
                        </div>
                        <div class="pt-2 border-t border-gray-200">
                            <strong class="text-base">Total Allocated: <span id="budgetTotal">0.00</span></strong>
                            <span id="budgetError" class="text-red-600 text-sm block" style="display:none;">Total allocation cannot exceed transaction amount.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description (Existing) -->
            <div>
                <label asp-for="Description" class="block text-base font-medium text-gray-700 mb-1" id="descriptionLabel"></label>
                <textarea asp-for="Description"
                          class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base"
                          rows="3"></textarea>
                <span asp-validation-for="Description" class="text-red-600 text-base mt-1"></span>
            </div>

            <!-- Step-Up Section (MODIFIED) -->
            <div id="stepUpContainer" style="display:none;" class="space-y-4">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input asp-for="IsStepUpTransaction" type="checkbox" id="stepUpToggle" class="sr-only peer" />
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-violet-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
                    <span class="ml-3 text-base font-medium text-gray-700">Enable Auto Increase</span>
                </label>

                <div id="stepUpCard" class="collapse-card" aria-hidden="true" style="display:none;">
                    <div class="p-4 rounded-lg bg-gray-50 shadow-inner space-y-4">
                        <h5 class="text-lg font-semibold text-gray-900">Auto Increase Settings</h5>

                        <!-- --- START OF RESTORED HTML --- -->
                        <div>
                            <label class="block text-base font-medium text-gray-700 mb-2">Increase Type</label>
                            <div class="flex gap-6">
                                <div class="flex items-center">
                                    <input class="w-4 h-4 text-violet-600 bg-gray-100 border-gray-400 focus:ring-violet-500" type="radio" name="stepUpType" id="stepUpTypeAmount" value="Amount" checked>
                                    <label class="ml-2 text-base text-gray-700" for="stepUpTypeAmount">Fixed Amount</label>
                                </div>
                                <div class="flex items-center">
                                    <input class="w-4 h-4 text-violet-600 bg-gray-100 border-gray-400 focus:ring-violet-500" type="radio" name="stepUpType" id="stepUpTypePercentage" value="Percentage">
                                    <label class="ml-2 text-base text-gray-700" for="stepUpTypePercentage">Percentage</label>
                                </div>
                            </div>
                        </div>

                        <div id="stepUpAmountGroup">
                            <label asp-for="StepUpAmount" class="block text-base font-medium text-gray-700 mb-1"></label>
                            <input asp-for="StepUpAmount" step="0.01" min="0"
                                   class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base"
                                   id="StepUpAmount" />
                            <span asp-validation-for="StepUpAmount" class="text-red-600 text-base mt-1"></span>
                        </div>

                        <div id="stepUpPercentageGroup" style="display:none;">
                            <label asp-for="StepUpPercentage" class="block text-base font-medium text-gray-700 mb-1"></label>
                            <input asp-for="StepUpPercentage" step="0.01" min="0" max="100"
                                   class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base"
                                   id="StepUpPercentage" />
                            <span asp-validation-for="StepUpPercentage" class="text-red-600 text-base mt-1"></span>
                        </div>

                        <div>
                            <label asp-for="StepUpFrequeny" class="block text-base font-medium text-gray-700 mb-1"></label>
                            <select asp-for="StepUpFrequeny" asp-items="ViewBag.RecurrenceFrequency"
                                    class="block w-full rounded-lg border-gray-400 p-2.5 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-base appearance-none bg-no-repeat bg-right pr-8"
                                    id="stepUpFrequencySelect">
                                <option value="">-- Select Frequency --</option>
                            </select>
                            <span asp-validation-for="StepUpFrequeny" class="text-red-600 text-base mt-1"></span>
                        </div>
                        <!-- --- END OF RESTORED HTML --- -->

                    </div>
                </div>
            </div>


            <!-- Submit (Existing) -->
            <div class="pt-6">
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 transition-all duration-300 transform hover:-translate-y-0.5">
                    Save Transaction
                </button>
            </div>

        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <style>
        .collapse-card {
            overflow: hidden;
            max-height: 0;
            transition: max-height 320ms cubic-bezier(.4,0,.2,1);
        }

            .collapse-card.show {
                max-height: 800px; /* Adjust as needed */
            }

        .required-field::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
            padding-left: 2px;
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- Cache All Selectors ---
            const mainAmountInput = document.getElementById('Amount');

            // Timeline / Frequency
            const timelineOneTime = document.getElementById("timeline_OneTime");
            const timelineRecurring = document.getElementById("timeline_Recurring");
            const frequencyContainer = document.getElementById("frequencyContainer");
            const frequencySelect = document.getElementById("frequencySelect");

            // Territory / Currency
            const territorySelect = document.getElementById("territorySelect");
            const currencyContainer = document.getElementById("currencyContainer");
            const currencySelect = document.getElementById("currencySelect"); // <-- MODIFIED: Use ID
            const userBaseCurrency = '@(ViewBag.UserCurrencyCode ?? "")'; // <-- NEW: Get base currency

            // Category
            const typeSelect = document.getElementById('categoryTypeSelect');
            const categorySelect = document.getElementById('categorySelect');
            const descriptionLabel = document.getElementById('descriptionLabel');
            const allCategoryOptions = Array.from(categorySelect.options);

            // --- MODIFIED: Step-Up Selectors ---
            const stepUpContainer = document.getElementById('stepUpContainer');
            const stepUpToggle = document.getElementById('stepUpToggle');
            const stepUpCard = document.getElementById('stepUpCard');
            // --- RESTORED SELECTORS ---
            const stepUpTypeAmount = document.getElementById('stepUpTypeAmount');
            const stepUpTypePercentage = document.getElementById('stepUpTypePercentage');
            const stepUpAmountGroup = document.getElementById('stepUpAmountGroup');
            const stepUpPercentageGroup = document.getElementById('stepUpPercentageGroup');
            const stepUpAmountInput = document.getElementById('StepUpAmount');
            const stepUpPercentageInput = document.getElementById('StepUpPercentage');
            const stepUpFrequencySelect = document.getElementById('stepUpFrequencySelect');
            // --- END RESTORED SELECTORS ---

            // Savings
            const savingsAllocationContainer = document.getElementById('savingsAllocationContainer');
            const isForSavingToggle = document.getElementById('isForSavingToggle');
            const savingsCard = document.getElementById('savingsCard');
            const allSavingItems = document.querySelectorAll('.saving-item');
            const savingsAllocationInputs = document.querySelectorAll('.allocation-amount[data-container="savings"]');
            const savingsTotalDisplay = document.getElementById('savingsTotal');
            const savingsErrorDisplay = document.getElementById('savingsError');

            // Budget
            const budgetAllocationContainer = document.getElementById('budgetAllocationContainer');
            const isForBudgetToggle = document.getElementById('isForBudgetToggle');
            const budgetCard = document.getElementById('budgetCard');
            const allBudgetItems = document.querySelectorAll('.budget-item');
            const budgetAllocationInputs = document.querySelectorAll('.allocation-amount[data-container="budget"]');
            const budgetTotalDisplay = document.getElementById('budgetTotal');
            const budgetErrorDisplay = document.getElementById('budgetError');

            // --- Generic Collapse Function ---
            function toggleCollapseCard(cardElement, show) {
                if (show) {
                    cardElement.style.display = "block";
                    window.requestAnimationFrame(() => {
                        cardElement.classList.add('show');
                        cardElement.setAttribute('aria-hidden', 'false');
                    });
                } else {
                    cardElement.classList.remove('show');
                    cardElement.setAttribute('aria-hidden', 'true');
                    setTimeout(() => {
                        if (!cardElement.classList.contains('show')) cardElement.style.display = "none";
                    }, 350);
                }
            }

            // --- Existing Functions ---
            function toggleFrequency() {
                if (timelineRecurring.checked) {
                    frequencyContainer.style.display = "block";
                    frequencySelect.setAttribute("required", "required");
                } else {
                    frequencyContainer.style.display = "none";
                    frequencySelect.removeAttribute("required");
                    frequencySelect.value = "";
                }
                updateStepUpAvailability();
            }

            // --- MODIFIED: toggleCurrency ---
            function toggleCurrency() {
                const selectedOptionText = territorySelect.options[territorySelect.selectedIndex].text;
                if (selectedOptionText === "International") {
                    currencyContainer.style.display = "block";
                    currencySelect.setAttribute("required", "required");
                    // --- NEW: Set default currency ---
                    if (userBaseCurrency) {
                        currencySelect.value = userBaseCurrency;
                    }
                    // --- END NEW ---
                } else {
                    currencyContainer.style.display = "none";
                    currencySelect.removeAttribute("required");
                    currencySelect.value = "";
                }
            }

            function filterCategories() {
                const selectedType = typeSelect.value;
                const currentCategoryValue = categorySelect.value;
                categorySelect.innerHTML = '<option value="">-- Select Category --</option>';

                allCategoryOptions.forEach(option => {
                    if (!option.value) return;
                    if (!selectedType || option.getAttribute('data-type') === selectedType) {
                        categorySelect.appendChild(option.cloneNode(true));
                    }
                });

                if (categorySelect.querySelector(`option[value="${currentCategoryValue}"]`)) {
                    categorySelect.value = currentCategoryValue;
                } else {
                    categorySelect.value = "";
                }
            }

            function toggleDescriptionRequirement() {
                descriptionLabel.classList.add('required-field');
            }

            // --- RESTORED: Step-Up Functions ---
            function clearStepUpFields() {
                stepUpAmountInput.value = "";
                stepUpAmountInput.removeAttribute('required');
                stepUpPercentageInput.value = "";
                stepUpPercentageInput.removeAttribute('required');
                stepUpFrequencySelect.value = "";
                stepUpFrequencySelect.removeAttribute('required');
            }

            function updateStepUpTypeUI() {
                if (stepUpTypePercentage.checked) {
                    stepUpAmountGroup.style.display = 'none';
                    stepUpPercentageGroup.style.display = 'block';
                    if (stepUpToggle.checked) {
                        stepUpPercentageInput.setAttribute('required', 'required');
                        stepUpAmountInput.removeAttribute('required');
                    }
                } else {
                    stepUpAmountGroup.style.display = 'block';
                    stepUpPercentageGroup.style.display = 'none';
                    if (stepUpToggle.checked) {
                        stepUpAmountInput.setAttribute('required', 'required');
                        stepUpPercentageInput.removeAttribute('required');
                    }
                }
            }

            // --- MODIFIED: updateStepUpAvailability ---
            function updateStepUpAvailability() {
                if (timelineRecurring.checked) {
                    stepUpContainer.style.display = "block";
                } else {
                    stepUpContainer.style.display = "none";
                    stepUpToggle.checked = false;
                    toggleCollapseCard(stepUpCard, false);
                    clearStepUpFields(); // <-- RESTORED
                }
            }

            // --- MODIFIED: Allocation Functions ---
            function updateAllocationVisibility() {
                const selectedType = typeSelect.value;
                const selectedCategoryId = categorySelect.value;

                // Hide/show top-level containers
                // --- MODIFIED: Added check for selectedCategoryId ---
                if (selectedType === 'Income' && selectedCategoryId) {
                    savingsAllocationContainer.style.display = 'block';
                    budgetAllocationContainer.style.display = 'none';
                    isForBudgetToggle.checked = false;
                    toggleCollapseCard(budgetCard, false);
                    clearAllocationInputs(budgetAllocationInputs);
                } else if (selectedType === 'Expense' && selectedCategoryId) { // <-- MODIFIED
                    savingsAllocationContainer.style.display = 'none';
                    budgetAllocationContainer.style.display = 'block';
                    isForSavingToggle.checked = false;
                    toggleCollapseCard(savingsCard, false);
                    clearAllocationInputs(savingsAllocationInputs);
                } else {
                    savingsAllocationContainer.style.display = 'none';
                    budgetAllocationContainer.style.display = 'none';
                    isForSavingToggle.checked = false;
                    isForBudgetToggle.checked = false;
                    toggleCollapseCard(savingsCard, false);
                    toggleCollapseCard(budgetCard, false);
                    clearAllocationInputs(savingsAllocationInputs);
                    clearAllocationInputs(budgetAllocationInputs);
                }
                // --- END MODIFICATION ---

                // Filter items within containers
                filterAllocationItems(allSavingItems, selectedCategoryId);
                filterAllocationItems(allBudgetItems, selectedCategoryId);

                // Re-validate
                validateAllocations('savings');
                validateAllocations('budget');
            }

            function filterAllocationItems(items, selectedCategoryId) {
                items.forEach(item => {
                    const itemCatId = item.getAttribute('data-category-id');
                    if (!selectedCategoryId || itemCatId === selectedCategoryId || itemCatId === 'general') {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                        const input = item.querySelector('.allocation-amount');
                        if (input) input.value = '';
                    }
                });
            }

            function clearAllocationInputs(inputs) {
                inputs.forEach(input => input.value = '');
            }

            function validateAllocations(type) {
                const mainAmount = parseFloat(mainAmountInput.value) || 0;
                let totalAllocation = 0;
                let inputs, totalDisplay, errorDisplay;

                if (type === 'savings') {
                    inputs = savingsAllocationInputs;
                    totalDisplay = savingsTotalDisplay;
                    errorDisplay = savingsErrorDisplay;
                } else {
                    inputs = budgetAllocationInputs;
                    totalDisplay = budgetTotalDisplay;
                    errorDisplay = budgetErrorDisplay;
                }

                inputs.forEach(input => {
                    if (input.offsetParent !== null) {
                        totalAllocation += parseFloat(input.value) || 0;
                    }
                });

                totalDisplay.textContent = totalAllocation.toFixed(2);

                if (totalAllocation > mainAmount) {
                    errorDisplay.style.display = 'block';
                } else {
                    errorDisplay.style.display = 'none';
                }
            }

            // --- Event Listeners ---
            timelineOneTime.addEventListener("change", toggleFrequency);
            timelineRecurring.addEventListener("change", toggleFrequency);
            territorySelect.addEventListener("change", toggleCurrency);
            categorySelect.addEventListener("change", toggleDescriptionRequirement);

            // Allocation listeners
            typeSelect.addEventListener("change", () => {
                filterCategories();
                updateAllocationVisibility();
            });
            categorySelect.addEventListener("change", updateAllocationVisibility);

            isForSavingToggle.addEventListener('change', function () {
                toggleCollapseCard(savingsCard, this.checked);
            });
            isForBudgetToggle.addEventListener('change', function () {
                toggleCollapseCard(budgetCard, this.checked);
            });

            // Validation Listeners
            mainAmountInput.addEventListener('input', () => {
                validateAllocations('savings');
                validateAllocations('budget');
            });
            savingsAllocationInputs.forEach(input => input.addEventListener('input', () => validateAllocations('savings')));
            budgetAllocationInputs.forEach(input => input.addEventListener('input', () => validateAllocations('budget')));

            // --- MODIFIED: Step-Up Listeners ---
            stepUpToggle.addEventListener('change', function () {
                toggleCollapseCard(stepUpCard, this.checked);
                // --- RESTORED ---
                if (this.checked) {
                    updateStepUpTypeUI();
                    stepUpFrequencySelect.setAttribute('required', 'required');
                } else {
                    clearStepUpFields();
                }
                // --- END RESTORED ---
            });

            // --- RESTORED LISTENERS ---
            stepUpTypeAmount.addEventListener('change', updateStepUpTypeUI);
            stepUpTypePercentage.addEventListener('change', updateStepUpTypeUI);
            // --- END RESTORED LISTENERS ---

            // --- Initialize State ---
            toggleFrequency();
            toggleCurrency();
            filterCategories();
            updateAllocationVisibility();
            updateStepUpTypeUI(); // <-- RESTORED
            updateStepUpAvailability();
        });
    </script>
}